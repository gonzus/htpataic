<!DOCTYPE html>
<html>
<head>
<title>21. Multi-player</title>
<link rel="stylesheet" href="htpataic.css" type="text/css" />
</head>
<body>
<table class="contents"><tr><td>
<h4>Contents</h4>
<div><a href="htpataic01.html">1. Introduction</a></div>
<div><a href="htpataic02.html">2. The main loop</a></div>
<div><a href="htpataic03.html">3. Locations</a></div>
<div><a href="htpataic04.html">4. Objects</a></div>
<div><a href="htpataic05.html">5. Inventory</a></div>
<div><a href="htpataic06.html">6. Passages</a></div>
<div><a href="htpataic07.html">7. Distance</a></div>
<div><a href="htpataic08.html">8. North, east, south, west</a></div>
<div><a href="htpataic09.html">9. Code generation</a></div>
<div><a href="htpataic10.html">10. More attributes</a></div>
<div><a href="htpataic11.html">11. Conditions</a></div>
<div><a href="htpataic12.html">12. Open and close</a></div>
<div><a href="htpataic13.html">13. The parser</a></div>
<div><a href="htpataic14.html">14. Multiple nouns</a></div>
<div><a href="htpataic15.html">15. Light and dark</a></div>
<div><a href="htpataic16.html">16. Savegame</a></div>
<div><a href="htpataic17.html">17. Test automation</a></div>
<div><a href="htpataic18.html">18. Abbreviations</a></div>
<div><a href="htpataic19.html">19. Conversations</a></div>
<div><a href="htpataic20.html">20. Combat</a></div>
<div><b>21. Multi-player</b></div>
<div><a href="htpataic22.html">22. Client-server</a></div>
<div><a href="htpataic23.html">23. Database</a></div>
<div><a href="htpataic24.html">24. Speech</a></div>
<div><a href="htpataic25.html">25. JavaScript</a></div>
</td></tr></table>

<h1>How to program a text adventure in C</h1>
<p>
by Ruud Helderman
&lt;<a href="mailto:r.helderman@hccnet.nl">r.helderman@hccnet.nl</a>&gt;
</p>
<p>
Licensed under
<a href="https://github.com/helderman/htpataic/blob/master/LICENSE">MIT License</a>
</p>
<h2>21. Multi-player</h2>
<p class="intro">
It wasn&rsquo;t long after the first text adventures appeared,
that somebody came with the idea to make it a multi-user event.
<a href="https://en.wikipedia.org/wiki/MUD">MUDs</a>
flourished on university networks,
then gradually found their way to home users through
<a href="https://en.wikipedia.org/wiki/Bulletin_Board_Systems">BBSs</a>.
Later, widespread internet access paved the way for
<a href="https://en.wikipedia.org/wiki/Massively_multiplayer_online_game">MMOs</a>,
but by that time, attention had already shifted
from text-based gaming to 3D graphics.
Sure, the whole world is
<a href="https://en.wikipedia.org/wiki/Text_messaging">texting</a>,
but even among gamers, few are aware you can use that for
<a href="https://en.wikipedia.org/wiki/Role-playing">role-playing</a>.
</p>
<p>
Multi-player is a rather broad term. It could stand for:
</p>
<ol type="1">
<li>Having multiple
<a href="https://en.wikipedia.org/wiki/Player_character">player characters</a>
in the same game.
</li>
<li>Having multiple
<a href="https://en.wikipedia.org/wiki/User_(computing)">users</a>
together playing within the same game session.
</li>
</ol>
<p>
In most cases, both apply, and there will be a one-on-one relationship,
i.e. every user controls one player character.
But it doesn&rsquo;t have to be this way:
it is very well possible to make a game
where a single user is controlling multiple player characters.
That may not be everybody&rsquo;s idea of fun, but technically,
these are separate dimensions, largely independent of each other.
And since there&rsquo;s plenty of work to be done,
it makes sense to divide it across two chapters.
Below, we will introduce the concept of having more than one player character,
while at the same time keeping the game a single-user experience.
In the next chapter, we will make the game truly multi-user.
</p>
<p>
In its simplest form, multiple player characters means
the user will be given the opportunity to switch between characters,
controlling them one at a time.
Imagine we have two player characters: <i>Jack</i> and <i>Jill</i>.
We could introduce a command &lsquo;play&rsquo;
that allows the user to take control of either one of those characters.
The following four commands would then make
Jack pick up the club, and Jill pick up the dagger.
</p>
<table><tr>
<td class="snippet">play jack
get club
play jill
get dagger
</td>
</tr></table>
<p>
Multiple player characters could be a nice opportunity
to have puzzles in your game that can only be solved
by having the characters cooperate in a certain way.
For example, one character could be used to distract or lure away the guard,
while the other character sneaks into the cave.
Puzzles might also demand the user to carefully think about
each character&rsquo;s strengths and weaknesses.
</p>
<p>
It won&rsquo;t be until the next chapter
that we will benefit from the <i>social</i> aspect of multi-player:
being able to really interact (remotely) with other human beings.
But since we are expanding our vocabulary anyway (the verb <i>play</i>),
we might as well take the opportunity
to introduce some &lsquo;social&rsquo; commands.
</p>
<ul>
<li><b>say</b> -
to send a message to everybody present in the same location.
</li>
<li><b>whisper</b> -
to send a message to a specific player character,
without exposing it to others present in the same location.
</li>
<li><a href="https://en.wikipedia.org/wiki/Emote">emote</a> -
similar to <i>say</i>, but for
<a href="https://en.wikipedia.org/wiki/Nonverbal_communication">non-verbal communication</a>.
MUD-like games typically use this to facilitate
<a href="https://en.wikipedia.org/wiki/Role-playing">role-playing</a>.
</li>
</ul>
<p>
Let&rsquo;s start by adding the new verbs to our vocabulary.
</p>
<table class="demo">
<tr><th>Sample output</th></tr>
<tr><td>
Welcome to Little Cave Adventure.<br />
You are in the waiting room.<br />
You see:<br />
walls all around you<br />
<br />
--&gt; play jack<br />
You are Jack. Jack is a fearsome warrior.<br />
<br />
--&gt; look around<br />
You are in an open field.<br />
You see:<br />
a silver coin<br />
a burly guard<br />
Jill<br />
a cave entrance to the east<br />
dense forest all around<br />
a lamp<br />
a wooden club<br />
a dagger<br />
<br />
--&gt; get club<br />
You pick up a wooden club.<br />
<br />
--&gt; play jill<br />
You are Jill. Jill is a vicious valkyrie.<br />
<br />
--&gt; look around<br />
You are in an open field.<br />
You see:<br />
a silver coin<br />
a burly guard<br />
Jack<br />
a cave entrance to the east<br />
dense forest all around<br />
a lamp<br />
a dagger<br />
<br />
--&gt; say Where am I?<br />
You say: Where am I?<br />
<br />
--&gt; whisper to jack I need a weapon.<br />
You whisper to Jack: I need a weapon.<br />
<br />
--&gt; get dagger<br />
You pick up a dagger.<br />
<br />
--&gt; emote assume a fighting stance.<br />
You assume a fighting stance.<br />
<br />
--&gt; attack guard<br />
You hit a burly guard with a dagger.<br />
You are hit by a burly guard with bare hands.<br />
<br />
--&gt; play jill<br />
You already are Jill.<br />
<br />
--&gt; play jack<br />
You are Jack. Jack is a fearsome warrior.<br />
<br />
--&gt; attack guard<br />
You hit a burly guard with a wooden club.<br />
<br />
--&gt; quit<br />
<br />
Bye!<br />
</td></tr>
</table>
<table class="code"><tr>
<th>parsexec.c</th>
</tr><tr>
<td>
<ol>
<li class="old">#include &lt;ctype.h&gt;</li>
<li class="old">#include &lt;stdbool.h&gt;</li>
<li class="old">#include &lt;stdio.h&gt;</li>
<li class="old">#include "object.h"</li>
<li class="old">#include "misc.h"</li>
<li class="old">#include "match.h"</li>
<li class="old">#include "location.h"</li>
<li class="old">#include "inventory.h"</li>
<li class="old">#include "inventory2.h"</li>
<li class="old">#include "openclose.h"</li>
<li class="old">#include "onoff.h"</li>
<li class="old">#include "talk.h"</li>
<li class="old">#include "attack.h"</li>
<li class="new">#include "social.h"</li>
<li class="old"></li>
<li class="old">typedef struct</li>
<li class="old">{</li>
<li class="old">   const char *pattern;</li>
<li class="old">   int (*function)(void);</li>
<li class="old">} COMMAND;</li>
<li class="old"></li>
<li class="old">static int executeQuit(void)</li>
<li class="old">{</li>
<li class="old">   return -1;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">static int executeNoMatch(void)</li>
<li class="old">{</li>
<li class="old">   const char *src = *params;</li>
<li class="old">   int len;</li>
<li class="old">   for (len = 0; src[len] != '\0' &amp;&amp; !isspace(src[len]); len++);</li>
<li class="old">   if (len &gt; 0) printf("I don't know how to '%.*s'.\n", len, src);</li>
<li class="old">   return 0;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">static int executeWait(void)</li>
<li class="old">{</li>
<li class="old">   printf("Some time passes...\n");</li>
<li class="old">   return 1;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">int parseAndExecute(const char *input)</li>
<li class="old">{</li>
<li class="old">   static const COMMAND commands[] =</li>
<li class="old">   {</li>
<li class="old">      { "quit"                , executeQuit       },</li>
<li class="old">      { "look"                , executeLookAround },</li>
<li class="old">      { "look around"         , executeLookAround },</li>
<li class="old">      { "look at A"           , executeLook       },</li>
<li class="old">      { "look A"              , executeLook       },</li>
<li class="old">      { "examine A"           , executeLook       },</li>
<li class="old">      { "go to A"             , executeGo         },</li>
<li class="old">      { "go A"                , executeGo         },</li>
<li class="old">      { "get A from B"        , executeGetFrom    },</li>
<li class="old">      { "get A"               , executeGet        },</li>
<li class="old">      { "put A in B"          , executePutIn      },</li>
<li class="old">      { "drop A in B"         , executePutIn      },</li>
<li class="old">      { "drop A"              , executeDrop       },</li>
<li class="old">      { "ask A from B"        , executeAskFrom    },</li>
<li class="old">      { "ask A"               , executeAsk        },</li>
<li class="old">      { "give A to B"         , executeGiveTo     },</li>
<li class="old">      { "give A"              , executeGive       },</li>
<li class="old">      { "inventory"           , executeInventory  },</li>
<li class="old">      { "open A"              , executeOpen       },</li>
<li class="old">      { "close A"             , executeClose      },</li>
<li class="old">      { "lock A"              , executeLock       },</li>
<li class="old">      { "unlock A"            , executeUnlock     },</li>
<li class="old">      { "turn on A"           , executeTurnOn     },</li>
<li class="old">      { "turn off A"          , executeTurnOff    },</li>
<li class="old">      { "turn A on"           , executeTurnOn     },</li>
<li class="old">      { "turn A off"          , executeTurnOff    },</li>
<li class="old">      { "talk with B about A" , executeTalkTo     },</li>
<li class="old">      { "talk about A with B" , executeTalkTo     },</li>
<li class="old">      { "talk about A"        , executeTalk       },</li>
<li class="old">      { "talk A"              , executeTalk       },</li>
<li class="old">      { "attack with B"       , executeAttack     },</li>
<li class="old">      { "attack A with B"     , executeAttack     },</li>
<li class="old">      { "attack A"            , executeAttack     },</li>
<li class="old">      { "wait"                , executeWait       },</li>
<li class="new">      { "play A"              , executePlay       },</li>
<li class="new">      { "emote A"             , executeEmote      },</li>
<li class="new">      { "say A"               , executeSay        },</li>
<li class="new">      { "whisper to B A"      , executeWhisper    },</li>
<li class="old">      { "A"                   , executeNoMatch    }</li>
<li class="old">   };</li>
<li class="old">   const COMMAND *cmd;</li>
<li class="old">   for (cmd = commands; !matchCommand(input, cmd-&gt;pattern); cmd++);</li>
<li class="old">   return (*cmd-&gt;function)();</li>
<li class="old">}</li>
</ol>
</td>
</tr></table>
<p>
The implementation of the new commands is extremely straightforward.
Of course, the &lsquo;social&rsquo; commands are not very useful yet.
Being the only user, you are basically talking to yourself.
But it does give us the foundation to actually socialize in the next chapter.
</p>
<table class="code"><tr>
<th>social.h</th>
</tr><tr>
<td>
<ol>
<li class="new">extern int executePlay(void);</li>
<li class="new">extern int executeEmote(void);</li>
<li class="new">extern int executeSay(void);</li>
<li class="new">extern int executeWhisper(void);</li>
</ol>
</td>
</tr><tr>
<th>social.c</th>
</tr><tr>
<td>
<ol>
<li class="new">#include &lt;stdbool.h&gt;</li>
<li class="new">#include &lt;stdio.h&gt;</li>
<li class="new">#include "object.h"</li>
<li class="new">#include "match.h"</li>
<li class="new">#include "noun.h"</li>
<li class="new">#include "reach.h"</li>
<li class="new">#include "location.h"</li>
<li class="new"></li>
<li class="new">int executePlay(void)</li>
<li class="new">{</li>
<li class="new">   OBJECT *obj = getTopic(params[0]);</li>
<li class="new">   if (obj == NULL)</li>
<li class="new">   {</li>
<li class="new">      printf("I don't understand what character you want to play.\n");</li>
<li class="new">   }</li>
<li class="new">   else if (obj == player)</li>
<li class="new">   {</li>
<li class="new">      printf("You already are %s.\n", player-&gt;description);</li>
<li class="new">   }</li>
<li class="new">   else if (obj == jack || obj == jill)</li>
<li class="new">   {</li>
<li class="new">      player = obj;</li>
<li class="new">      printf("You are %s. %s\n", player-&gt;description, player-&gt;details);</li>
<li class="new">   }</li>
<li class="new">   else</li>
<li class="new">   {</li>
<li class="new">      printf("That is not a character you can play.\n");</li>
<li class="new">   }</li>
<li class="new">   return 0;</li>
<li class="new">}</li>
<li class="new"></li>
<li class="new">int executeEmote(void)</li>
<li class="new">{</li>
<li class="new">   const char *phrase = params[0];</li>
<li class="new">   if (*phrase == '\0')</li>
<li class="new">   {</li>
<li class="new">      printf("I don't understand what you want to emote.\n");</li>
<li class="new">   }</li>
<li class="new">   else</li>
<li class="new">   {</li>
<li class="new">      printf("You %s\n", phrase);</li>
<li class="new">   }</li>
<li class="new">   return 0;</li>
<li class="new">}</li>
<li class="new"></li>
<li class="new">int executeSay(void)</li>
<li class="new">{</li>
<li class="new">   const char *phrase = params[0];</li>
<li class="new">   if (*phrase == '\0')</li>
<li class="new">   {</li>
<li class="new">      printf("I don't understand what you want to say.\n");</li>
<li class="new">   }</li>
<li class="new">   else</li>
<li class="new">   {</li>
<li class="new">      printf("You say: %s\n", phrase);</li>
<li class="new">   }</li>
<li class="new">   return 0;</li>
<li class="new">}</li>
<li class="new"></li>
<li class="new">int executeWhisper(void)</li>
<li class="new">{</li>
<li class="new">   OBJECT *to = reachableObject("who to whisper to", params[1]);</li>
<li class="new">   if (to != NULL)</li>
<li class="new">   {</li>
<li class="new">      const char *phrase = params[0];</li>
<li class="new">      if (*phrase == '\0')</li>
<li class="new">      {</li>
<li class="new">         printf("I don't understand what you want to whisper.\n");</li>
<li class="new">      }</li>
<li class="new">      else</li>
<li class="new">      {</li>
<li class="new">         printf("You whisper to %s: %s\n", to-&gt;description, phrase);</li>
<li class="new">      }</li>
<li class="new">   }</li>
<li class="new">   return 0;</li>
<li class="new">}</li>
</ol>
</td>
</tr></table>
<div class="explanation">
<p>
Explanation:
</p>
<ul>
<li>Line 20:
here is a whitelist of viable player characters.
Do not forget to extend the list when introducing more player characters.
Alternatively, we could add a new attribute to <i>OBJECT</i>
to flag objects that can be impersonated by a user.
</li>
</ul>
</div>
<p>
However, we cannot just assign a new value to <i>player</i>
(see line 22 above) without turning it into a variable.
</p>
<table class="code"><tr>
<th>object.awk</th>
</tr><tr>
<td>
<ol>
<li class="old">BEGIN {</li>
<li class="old">   count = 0;</li>
<li class="old">   obj = "";</li>
<li class="old">   if (pass == "c2") {</li>
<li class="old">      print "\nstatic bool alwaysTrue(void) { return true; }";</li>
<li class="old">      print "\nOBJECT objs[] = {";</li>
<li class="old">   }</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">/^- / {</li>
<li class="old">   outputRecord(",");</li>
<li class="old">   obj = $2;</li>
<li class="old">   prop["condition"]   = "alwaysTrue";</li>
<li class="old">   prop["description"] = "NULL";</li>
<li class="old">   prop["tags"]        = "";</li>
<li class="old">   prop["location"]    = "NULL";</li>
<li class="old">   prop["destination"] = "NULL";</li>
<li class="old">   prop["prospect"]    = "";</li>
<li class="old">   prop["details"]     = "\"You see nothing special.\"";</li>
<li class="old">   prop["contents"]    = "\"You see\"";</li>
<li class="old">   prop["textGo"]      = "\"You can't get much closer than this.\"";</li>
<li class="old">   prop["gossip"]      = "\"I know nothing about that.\"";</li>
<li class="old">   prop["weight"]      = "99";</li>
<li class="old">   prop["capacity"]    = "0";</li>
<li class="old">   prop["health"]      = "0";</li>
<li class="old">   prop["light"]       = "0";</li>
<li class="old">   prop["impact"]      = "0";</li>
<li class="old">   prop["trust"]       = "0";</li>
<li class="old">   prop["open"]        = "cannotBeOpened";</li>
<li class="old">   prop["close"]       = "cannotBeClosed";</li>
<li class="old">   prop["lock"]        = "cannotBeLocked";</li>
<li class="old">   prop["unlock"]      = "cannotBeUnlocked";</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">obj &amp;&amp; /^[ \t]+[a-z]/ {</li>
<li class="old">   name = $1;</li>
<li class="old">   $1 = "";</li>
<li class="old">   if (name in prop) {</li>
<li class="old">      prop[name] = $0;</li>
<li class="old">      if (/^[ \t]*\{/) {</li>
<li class="old">         prop[name] = name count;</li>
<li class="old">         if (pass == "c1") print "static bool " prop[name] "(void) " $0;</li>
<li class="old">      }</li>
<li class="old">   }</li>
<li class="old">   else if (pass == "c2") {</li>
<li class="old">      print "#error \"" FILENAME " line " NR ": unknown attribute '" name "'\"";</li>
<li class="old">   }</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">!obj &amp;&amp; pass == (/^#include/ ? "c1" : "h") {</li>
<li class="old">   print;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">END {</li>
<li class="new"><span class="old">   </span>outputRecord("\n}, *player = nobody;");</li>
<li class="old">   if (pass == "h") {</li>
<li class="old">      print "\n#define endOfObjs\t(objs + " count ")";</li>
<li class="old">      print "\n#define validObject(obj)\t" \</li>
<li class="old">            "((obj) != NULL &amp;&amp; (*(obj)-&gt;condition)())";</li>
<li class="old">   }</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">function outputRecord(separator)</li>
<li class="old">{</li>
<li class="old">   if (obj) {</li>
<li class="old">      if (pass == "h") {</li>
<li class="old">         print "#define " obj "\t(objs + " count ")";</li>
<li class="old">      }</li>
<li class="old">      else if (pass == "c1") {</li>
<li class="old">         print "static const char *tags" count "[] = {" prop["tags"] ", NULL};";</li>
<li class="old">      }</li>
<li class="old">      else if (pass == "c2") {</li>
<li class="old">         print "\t{\t/* " count " = " obj " */";</li>
<li class="old">         print "\t\t" prop["condition"] ",";</li>
<li class="old">         print "\t\t" prop["description"] ",";</li>
<li class="old">         print "\t\ttags" count ",";</li>
<li class="old">         print "\t\t" prop["location"] ",";</li>
<li class="old">         print "\t\t" prop["destination"] ",";</li>
<li class="old">         print "\t\t" prop[prop["prospect"] ? "prospect" : "destination"] ",";</li>
<li class="old">         print "\t\t" prop["details"] ",";</li>
<li class="old">         print "\t\t" prop["contents"] ",";</li>
<li class="old">         print "\t\t" prop["textGo"] ",";</li>
<li class="old">         print "\t\t" prop["gossip"] ",";</li>
<li class="old">         print "\t\t" prop["weight"] ",";</li>
<li class="old">         print "\t\t" prop["capacity"] ",";</li>
<li class="old">         print "\t\t" prop["health"] ",";</li>
<li class="old">         print "\t\t" prop["light"] ",";</li>
<li class="old">         print "\t\t" prop["impact"] ",";</li>
<li class="old">         print "\t\t" prop["trust"] ",";</li>
<li class="old">         print "\t\t" prop["open"] ",";</li>
<li class="old">         print "\t\t" prop["close"] ",";</li>
<li class="old">         print "\t\t" prop["lock"] ",";</li>
<li class="old">         print "\t\t" prop["unlock"];</li>
<li class="old">         print "\t}" separator;</li>
<li class="old">         delete prop;</li>
<li class="old">      }</li>
<li class="old">      count++;</li>
<li class="old">   }</li>
<li class="old">}</li>
</ol>
</td>
</tr></table>
<div class="explanation">
<p>
Explanation:
</p>
<ul>
<li>Line 55:
<i>player</i> is now a pointer variable; it can be made to point to any object.
Initially, it will be pointing to object <i>nobody</i>, defined below.
</li>
</ul>
</div>
<p>
Up until now, <i>player</i> has been a fixed object.
We will get rid of that object,
and instead introduce &lsquo;named&rsquo; character objects
<i>jack</i> and <i>jill</i>.
</p>
<table class="code"><tr>
<th>object.txt</th>
</tr><tr>
<td>
<ol>
<li class="old">#include &lt;stdbool.h&gt;</li>
<li class="old">#include &lt;stdio.h&gt;</li>
<li class="old">#include "object.h"</li>
<li class="old">#include "toggle.h"</li>
<li class="old"></li>
<li class="old">typedef struct object {</li>
<li class="old">   bool         (*condition)(void);</li>
<li class="old">   const char    *description;</li>
<li class="old">   const char   **tags;</li>
<li class="old">   struct object *location;</li>
<li class="old">   struct object *destination;</li>
<li class="old">   struct object *prospect;</li>
<li class="old">   const char    *details;</li>
<li class="old">   const char    *contents;</li>
<li class="old">   const char    *textGo;</li>
<li class="old">   const char    *gossip;</li>
<li class="old">   int            weight;</li>
<li class="old">   int            capacity;</li>
<li class="old">   int            health;</li>
<li class="old">   int            light;</li>
<li class="old">   int            impact;</li>
<li class="old">   int            trust;</li>
<li class="old">   void         (*open)(void);</li>
<li class="old">   void         (*close)(void);</li>
<li class="old">   void         (*lock)(void);</li>
<li class="old">   void         (*unlock)(void);</li>
<li class="old">} OBJECT;</li>
<li class="old"></li>
<li class="new"><span class="old">extern OBJECT </span>*player,<span class="old"> objs[];</span></li>
<li class="old"></li>
<li class="old">- heaven</li>
<li class="old">     description "little heaven"</li>
<li class="old">     tags        "heaven", "little heaven"</li>
<li class="old">     details     "Everything looks so peaceful here."</li>
<li class="old">     gossip      "It's where all the good adventurers go."</li>
<li class="old">     capacity    9999</li>
<li class="old">     light       100</li>
<li class="old"></li>
<li class="old">- respawn</li>
<li class="old">     description "a respawn portal"</li>
<li class="old">     tags        "portal", "respawn portal"</li>
<li class="old">     location    heaven</li>
<li class="old">     destination field</li>
<li class="old">     details     "Looks like a gateway into the unknown."</li>
<li class="old">     textGo      "A bright flash of light, and you are back in the field."</li>
<li class="old">     open        isAlreadyOpen</li>
<li class="old"></li>
<li class="old">- heavenEWNS</li>
<li class="old">     description "nothing but peace and quiet"</li>
<li class="old">     tags        "east", "west", "north", "south"</li>
<li class="old">     location    heaven</li>
<li class="old">     textGo      "In this dimension, there are no directions."</li>
<li class="old">     gossip      "It's just a compass direction."</li>
<li class="old"></li>
<li class="new"><span class="old">- </span>waitingRoom</li>
<li class="new">     description "the waiting room"</li>
<li class="new">     tags        "room", "waiting room"</li>
<li class="new">     details     "This is where everybody starts. Please enter: play YourName."</li>
<li class="new">     gossip      "It's where all the bad adventurers have to stay."</li>
<li class="new">     capacity    9999</li>
<li class="new">     light       100</li>
<li class="new"></li>
<li class="new">- waitingRoomWall</li>
<li class="new">     description "walls all around you"</li>
<li class="new">     tags        "wall", "east", "west", "north", "south"</li>
<li class="new">     location    waitingRoom</li>
<li class="new">     details     "Written on the wall, it says: play Jack or play Jill."</li>
<li class="new">     textGo      "You cannot go anywhere."</li>
<li class="new"></li>
<li class="new">- nobody</li>
<li class="new">     description "nobody"</li>
<li class="new">     tags        "nobody"</li>
<li class="new">     location    waitingRoom</li>
<li class="new">     details     "You are nobody. Please enter: play xxx"</li>
<li class="new">     contents    "You have"</li>
<li class="new">     health      100</li>
<li class="new">     capacity    1</li>
<li class="new"></li>
<li class="new">-<span class="old"> field</span></li>
<li class="old">     description "an open field"</li>
<li class="old">     tags        "field"</li>
<li class="old">     details     "The field is a nice and quiet place under a clear blue sky."</li>
<li class="old">     gossip      "A lot of tourists go there."</li>
<li class="old">     capacity    9999</li>
<li class="old">     light       100</li>
<li class="old"></li>
<li class="old">- cave</li>
<li class="old">     description "a little cave"</li>
<li class="old">     tags        "cave"</li>
<li class="old">     details     "The cave is just a cold, damp, rocky chamber."</li>
<li class="old">     gossip      "It's dark in there; bring a lamp!"</li>
<li class="old">     capacity    9999</li>
<li class="old"></li>
<li class="old">- silver</li>
<li class="old">     description "a silver coin"</li>
<li class="old">     tags        "silver", "coin", "silver coin"</li>
<li class="old">     location    field</li>
<li class="old">     details     "The coin has an eagle on the obverse."</li>
<li class="old">     gossip      "Money makes the world go round..."</li>
<li class="old">     weight      1</li>
<li class="old"></li>
<li class="old">- gold</li>
<li class="old">     description "a gold coin"</li>
<li class="old">     tags        "gold", "coin", "gold coin"</li>
<li class="old">     location    openBox</li>
<li class="old">     details     "The shiny coin seems to be a rare and priceless artefact."</li>
<li class="old">     gossip      "Money makes the world go round..."</li>
<li class="old">     weight      1</li>
<li class="old"></li>
<li class="old">- guard</li>
<li class="old">     description "a burly guard"</li>
<li class="old">     tags        "guard", "burly guard"</li>
<li class="old">     location    field</li>
<li class="old">     details     "The guard is a really big fellow."</li>
<li class="old">     gossip      "Easy to bribe..."</li>
<li class="old">     contents    "He has"</li>
<li class="old">     health      100</li>
<li class="old">     impact      -1</li>
<li class="old">     capacity    20</li>
<li class="old"></li>
<li class="new"><span class="old">- </span>jack</li>
<li class="new"><span class="old">     description </span>"Jack"</li>
<li class="new"><span class="old">     tags        </span>"jack", "warrior", "man"</li>
<li class="old">     location    field</li>
<li class="new"><span class="old">     details     </span>"Jack is<span class="old"> a </span>fearsome warrior."</li>
<li class="new"><span class="old">     gossip      </span>"Jack is a fearsome warrior."</li>
<li class="new"><span class="old">     contents    </span>"Jack has"</li>
<li class="new">     health      100</li>
<li class="new">     impact      -1</li>
<li class="new">     capacity    20</li>
<li class="new"></li>
<li class="new">- jill</li>
<li class="new">     description "Jill"</li>
<li class="new">     tags        "jill", "valkyrie", "woman"</li>
<li class="new">     location    field</li>
<li class="new">     details     "Jill is a vicious valkyrie."</li>
<li class="new">     gossip      "Jill is a vicious valkyrie."</li>
<li class="new">     contents    "Jill has"</li>
<li class="old">     health      100</li>
<li class="old">     impact      -1</li>
<li class="old">     capacity    20</li>
<li class="old"></li>
<li class="old">- intoCave</li>
<li class="old">     condition   { return guard-&gt;health == 0 || silver-&gt;location == guard; }</li>
<li class="old">     description "a cave entrance to the east"</li>
<li class="old">     tags        "east", "entrance"</li>
<li class="old">     location    field</li>
<li class="old">     destination cave</li>
<li class="old">     details     "The entrance is just a narrow opening in a small outcrop."</li>
<li class="old">     textGo      "You walk into the cave."</li>
<li class="old">     open        isAlreadyOpen</li>
<li class="old"></li>
<li class="old">- intoCaveBlocked</li>
<li class="old">     condition   { return guard-&gt;health &gt; 0 &amp;&amp; silver-&gt;location != guard; }</li>
<li class="old">     description "a cave entrance to the east"</li>
<li class="old">     tags        "east", "entrance"</li>
<li class="old">     location    field</li>
<li class="old">     prospect    cave</li>
<li class="old">     details     "The entrance is just a narrow opening in a small outcrop."</li>
<li class="old">     textGo      "The guard stops you from walking into the cave."</li>
<li class="old">     open        isAlreadyOpen</li>
<li class="old"></li>
<li class="old">- exitCave</li>
<li class="old">     description "an exit to the west"</li>
<li class="old">     tags        "west", "exit"</li>
<li class="old">     location    cave</li>
<li class="old">     destination field</li>
<li class="old">     details     "Sunlight pours in through an opening in the cave's wall."</li>
<li class="old">     textGo      "You walk out of the cave."</li>
<li class="old">     open        isAlreadyOpen</li>
<li class="old"></li>
<li class="old">- wallField</li>
<li class="old">     description "dense forest all around"</li>
<li class="old">     tags        "west", "north", "south", "forest"</li>
<li class="old">     location    field</li>
<li class="old">     details     "The field is surrounded by trees and undergrowth."</li>
<li class="old">     textGo      "Dense forest is blocking the way."</li>
<li class="old">     gossip      "You cannot go there, it is impenetrable."</li>
<li class="old"></li>
<li class="old">- wallCave</li>
<li class="old">     description "solid rock all around"</li>
<li class="old">     tags        "east", "north", "rock"</li>
<li class="old">     location    cave</li>
<li class="old">     details     "Carved in stone is a secret password 'abccb'."</li>
<li class="old">     textGo      "Solid rock is blocking the way."</li>
<li class="old"></li>
<li class="old">- backroom</li>
<li class="old">     description "a backroom"</li>
<li class="old">     tags        "backroom"</li>
<li class="old">     details     "The room is dusty and messy."</li>
<li class="old">     gossip      "There is something of value to be found there."</li>
<li class="old">     capacity    9999</li>
<li class="old"></li>
<li class="old">- wallBackroom</li>
<li class="old">     description "solid rock all around"</li>
<li class="old">     tags        "east", "west", "south", "rock"</li>
<li class="old">     location    backroom</li>
<li class="old">     details     "Trendy wallpaper covers the rock walls."</li>
<li class="old">     textGo      "Solid rock is blocking the way."</li>
<li class="old"></li>
<li class="old">- openDoorToBackroom</li>
<li class="old">     description "an open door to the south"</li>
<li class="old">     tags        "south", "door", "doorway"</li>
<li class="old">     destination backroom</li>
<li class="old">     details     "The door is open."</li>
<li class="old">     textGo      "You walk through the door into a backroom."</li>
<li class="old">     open        isAlreadyOpen</li>
<li class="old">     close       toggleDoorToBackroom</li>
<li class="old"></li>
<li class="old">- closedDoorToBackroom</li>
<li class="old">     description "a closed door to the south"</li>
<li class="old">     tags        "south", "door", "doorway"</li>
<li class="old">     location    cave</li>
<li class="old">     prospect    backroom</li>
<li class="old">     details     "The door is closed."</li>
<li class="old">     textGo      "The door is closed."</li>
<li class="old">     open        toggleDoorToBackroom</li>
<li class="old">     close       isAlreadyClosed</li>
<li class="old"></li>
<li class="old">- openDoorToCave</li>
<li class="old">     description "an open door to the north"</li>
<li class="old">     tags        "north", "door", "doorway"</li>
<li class="old">     destination cave</li>
<li class="old">     details     "The door is open."</li>
<li class="old">     textGo      "You walk through the door into the cave."</li>
<li class="old">     open        isAlreadyOpen</li>
<li class="old">     close       toggleDoorToCave</li>
<li class="old"></li>
<li class="old">- closedDoorToCave</li>
<li class="old">     description "a closed door to the north"</li>
<li class="old">     tags        "north", "door", "doorway"</li>
<li class="old">     location    backroom</li>
<li class="old">     prospect    cave</li>
<li class="old">     details     "The door is closed."</li>
<li class="old">     textGo      "The door is closed."</li>
<li class="old">     open        toggleDoorToCave</li>
<li class="old">     close       isAlreadyClosed</li>
<li class="old"></li>
<li class="old">- openBox</li>
<li class="old">     description "a wooden box"</li>
<li class="old">     tags        "box", "wooden box"</li>
<li class="old">     details     "The box is open."</li>
<li class="old">     gossip      "You need a key to open it."</li>
<li class="old">     weight      5</li>
<li class="old">     capacity    10</li>
<li class="old">     open        isAlreadyOpen</li>
<li class="old">     close       toggleBox</li>
<li class="old">     lock        isStillOpen</li>
<li class="old">     unlock      isAlreadyOpen</li>
<li class="old"></li>
<li class="old">- closedBox</li>
<li class="old">     description "a wooden box"</li>
<li class="old">     tags        "box", "wooden box"</li>
<li class="old">     details     "The box is closed."</li>
<li class="old">     weight      5</li>
<li class="old">     open        toggleBox</li>
<li class="old">     close       isAlreadyClosed</li>
<li class="old">     lock        toggleBoxLock</li>
<li class="old">     unlock      isAlreadyUnlocked</li>
<li class="old"></li>
<li class="old">- lockedBox</li>
<li class="old">     description "a wooden box"</li>
<li class="old">     tags        "box", "wooden box"</li>
<li class="old">     location    backroom</li>
<li class="old">     details     "The box is closed."</li>
<li class="old">     weight      5</li>
<li class="old">     open        isStillLocked</li>
<li class="old">     close       isAlreadyClosed</li>
<li class="old">     lock        isAlreadyLocked</li>
<li class="old">     unlock      toggleBoxLock</li>
<li class="old"></li>
<li class="old">- keyForBox</li>
<li class="old">     description "a tiny key"</li>
<li class="old">     tags        "key", "tiny key"</li>
<li class="old">     location    cave</li>
<li class="old">     details     "The key is really small and shiny."</li>
<li class="old">     gossip      "A small key opens a small lock."</li>
<li class="old">     weight      1</li>
<li class="old"></li>
<li class="old">- lampOff</li>
<li class="old">     description "a lamp"</li>
<li class="old">     tags        "lamp"</li>
<li class="old">     location    field</li>
<li class="old">     details     "The lamp is off."</li>
<li class="old">     gossip      "Essential in dark areas."</li>
<li class="old">     weight      5</li>
<li class="old"></li>
<li class="old">- lampOn</li>
<li class="old">     description "a lamp"</li>
<li class="old">     tags        "lamp"</li>
<li class="old">     details     "The lamp is on."</li>
<li class="old">     weight      5</li>
<li class="old">     light       100</li>
<li class="old"></li>
<li class="old">- club</li>
<li class="old">     description "a wooden club"</li>
<li class="old">     tags        "club", "wooden club"</li>
<li class="old">     location    field</li>
<li class="old">     details     "Two feet of solid wood."</li>
<li class="old">     weight      5</li>
<li class="old">     impact      -2</li>
<li class="old"></li>
<li class="old">- dagger</li>
<li class="old">     description "a dagger"</li>
<li class="old">     tags        "dagger"</li>
<li class="old">     location    field</li>
<li class="old">     details     "The dagger is very sharp."</li>
<li class="old">     weight      7</li>
<li class="old">     impact      -5</li>
</ol>
</td>
</tr></table>
<div class="explanation">
<p>
Explanation:
</p>
<ul>
<li>Line 29:
we are exposing variable <i>player</i>
to every module that includes <i>object.h</i>.
</li>
<li>Line 55-76:
until a user has specified for the first time
which character they will be playing (with command &lsquo;play&rsquo;),
they will be &lsquo;nobody&rsquo;.
<i>Nobody</i> is a dummy player character, locked up in a waiting room,
waiting for the user to switch over to a different player character.
</li>
<li>Line 120-140:
initially, <i>Jack</i> and <i>Jill</i> are both located in the field,
but of course it is also possible to let each one start in different locations.
</li>
</ul>
</div>
<p>
Traditionally, descriptive text about the player is always in second
<a href="https://en.wikipedia.org/wiki/Grammatical_person">person</a>,
e.g. &ldquo;<i>You are</i> in an open field.&rdquo;
But with multiple player characters, that is no longer the case.
Second person is still appropriate for
the player character that is currently under the user&rsquo;s control,
but any other player characters you meet, should be referenced in third person.
</p>
<p>
This is already giving trouble in command <i>inventory</i>.
The game&rsquo;s response has always started with &ldquo;You have&rdquo;,
as specified by attribute <i>contents</i> of the <i>player</i> object.
But for <i>Jack</i> and <i>Jill</i>, things are not so straightforward;
<i>contents</i> is used not only to inspect yourself (<i>inventory</i>),
but also to inspect someone else (e.g. Jill enters: <i>examine Jack</i>).
</p>
<p>
We will just keep it simple for now:
if the object being inspected is currently under the user&rsquo;s control,
then we will output a hardcoded &ldquo;You have&rdquo;
rather than attribute <i>contents</i>.
</p>
<table class="code"><tr>
<th>misc.c</th>
</tr><tr>
<td>
<ol>
<li class="old">#include &lt;stdbool.h&gt;</li>
<li class="old">#include &lt;stdio.h&gt;</li>
<li class="old">#include "object.h"</li>
<li class="old">#include "misc.h"</li>
<li class="old"></li>
<li class="old">bool isHolding(OBJECT *container, OBJECT *obj)</li>
<li class="old">{</li>
<li class="old">   return validObject(obj) &amp;&amp; obj-&gt;location == container;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">bool isLit(OBJECT *target)</li>
<li class="old">{</li>
<li class="old">   OBJECT *obj;</li>
<li class="old">   if (validObject(target))</li>
<li class="old">   {</li>
<li class="old">      if (target-&gt;light &gt; 0)</li>
<li class="old">      {</li>
<li class="old">         return true;</li>
<li class="old">      }</li>
<li class="old">      for (obj = objs; obj &lt; endOfObjs; obj++)</li>
<li class="old">      {</li>
<li class="old">         if (validObject(obj) &amp;&amp; obj-&gt;light &gt; 0 &amp;&amp;</li>
<li class="old">             (isHolding(target, obj) || isHolding(target, obj-&gt;location)))</li>
<li class="old">         {</li>
<li class="old">            return true;</li>
<li class="old">         }</li>
<li class="old">      }</li>
<li class="old">   }</li>
<li class="old">   return false;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">static bool isNoticeable(OBJECT *obj)</li>
<li class="old">{</li>
<li class="old">   return obj-&gt;location == player ||</li>
<li class="old">          isLit(obj) || isLit(obj-&gt;prospect) || isLit(player-&gt;location);</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">OBJECT *getPassage(OBJECT *from, OBJECT *to)</li>
<li class="old">{</li>
<li class="old">   if (from != NULL &amp;&amp; to != NULL)</li>
<li class="old">   {</li>
<li class="old">      OBJECT *obj;</li>
<li class="old">      for (obj = objs; obj &lt; endOfObjs; obj++)</li>
<li class="old">      {</li>
<li class="old">         if (isHolding(from, obj) &amp;&amp; obj-&gt;prospect == to)</li>
<li class="old">         {</li>
<li class="old">            return obj;</li>
<li class="old">         }</li>
<li class="old">      }</li>
<li class="old">   }</li>
<li class="old">   return NULL;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">DISTANCE getDistance(OBJECT *from, OBJECT *to)</li>
<li class="old">{</li>
<li class="old">   return to == NULL                               ? distUnknownObject :</li>
<li class="old">          !validObject(to)                         ? distNotHere :</li>
<li class="old">          to == from                               ? distSelf :</li>
<li class="old">          isHolding(from, to)                      ? distHeld :</li>
<li class="old">          !isNoticeable(to)                        ? distNotHere :</li>
<li class="old">          isHolding(to, from)                      ? distLocation :</li>
<li class="old">          isHolding(from-&gt;location, to)            ? distHere :</li>
<li class="old">          isHolding(from, to-&gt;location)            ? distHeldContained :</li>
<li class="old">          isHolding(from-&gt;location, to-&gt;location)  ? distHereContained :</li>
<li class="old">          getPassage(from-&gt;location, to) != NULL   ? distOverthere :</li>
<li class="old">                                                     distNotHere;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">OBJECT *actorHere(void)</li>
<li class="old">{</li>
<li class="old">   OBJECT *obj;</li>
<li class="old">   for (obj = objs; obj &lt; endOfObjs; obj++)</li>
<li class="old">   {</li>
<li class="old">      if (isHolding(player-&gt;location, obj) &amp;&amp; obj != player &amp;&amp;</li>
<li class="old">          isNoticeable(obj) &amp;&amp; obj-&gt;health &gt; 0)</li>
<li class="old">      {</li>
<li class="old">         return obj;</li>
<li class="old">      }</li>
<li class="old">   }</li>
<li class="old">   return NULL;</li>
<li class="old">}</li>
<li class="old"></li>
<li class="old">int listObjectsAtLocation(OBJECT *location)</li>
<li class="old">{</li>
<li class="old">   int count = 0;</li>
<li class="old">   OBJECT *obj;</li>
<li class="old">   for (obj = objs; obj &lt; endOfObjs; obj++)</li>
<li class="old">   {</li>
<li class="old">      if (obj != player &amp;&amp; isHolding(location, obj) &amp;&amp; isNoticeable(obj))</li>
<li class="old">      {</li>
<li class="old">         if (count++ == 0)</li>
<li class="old">         {</li>
<li class="new"><span class="old">            printf("%s:\n", </span>location == player ? "You have"</li>
<li class="new">                                               :<span class="old"> location-&gt;contents);</span></li>
<li class="old">         }</li>
<li class="old">         printf("%s\n", obj-&gt;description);</li>
<li class="old">      }</li>
<li class="old">   }</li>
<li class="old">   return count;</li>
<li class="old">}</li>
</ol>
</td>
</tr></table>
<p>
This was all fairly simple; it did not require a whole lot of source changes.
In the next chapter, we will be writing a lot more code,
as we are diving into the wonderful world of socket programming.
</p>
<hr />
<table class="download"><tr><td>
<a class="button" href="code21/src.zip">&#x2B73; &nbsp; Download source code</a>
<a class="button" href="https://repl.it/github/helderman/htpataic">&#x1F300; &nbsp; Run on Repl.it</a>
</td></tr></table>
<p>
Next chapter: <a href="htpataic22.html">22. Client-server</a>
</p>
</body>
</html>
